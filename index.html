<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Gas Monitor</title>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background-color: #0f172a; color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 380px; background: #1e293b; padding: 25px; border-radius: 28px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; position: relative; }
        
        /* GAUGE AREA - Using Conic Gradient for perfect fill */
        .gauge-wrapper {
            position: relative;
            width: 240px;
            height: 120px;
            margin: 0 auto 15px auto;
            overflow: hidden;
        }

        .gauge-body {
            width: 240px;
            height: 240px;
            border-radius: 50%;
            /* This creates the gray track and the colored progress */
            background: conic-gradient(
                from 270deg, 
                var(--g-color, #10b981) 0%, 
                var(--g-color, #10b981) var(--percentage, 0%), 
                #334155 var(--percentage, 0%), 
                #334155 50%, 
                transparent 50%
            );
            position: absolute;
            top: 0; left: 0;
            transition: --percentage 1s ease-in-out;
        }

        /* Hollow center to make it an arc, not a pie */
        .gauge-inner {
            position: absolute;
            top: 20px; left: 20px;
            width: 200px;
            height: 200px;
            background: #1e293b;
            border-radius: 50%;
            z-index: 2;
        }

        .weight-display { margin-top: 10px; z-index: 5; position: relative; }
        .weight-num { font-size: 58px; font-weight: 800; color: #f8fafc; line-height: 1; letter-spacing: -2px; }
        .unit { font-size: 20px; color: #94a3b8; margin-left: 2px; letter-spacing: 0; }
        
        #status-box { 
            padding: 18px; border-radius: 18px; margin-top: 20px; font-weight: bold;
            border: 2px solid transparent; transition: 0.4s; background: rgba(15, 23, 42, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .safe { color: #10b981; border-color: #10b981; }
        .danger { color: #ef4444; border-color: #ef4444; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        #time-stamp { font-size: 11px; color: #64748b; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <div class="container">
        <h3 style="color: #38bdf8; margin-bottom: 25px; font-size: 14px; letter-spacing: 2px; text-align: left; font-weight: 800;">LIVE GAS MONITOR</h3>

        <div class="gauge-wrapper">
            <div class="gauge-body" id="gauge-progress"></div>
            <div class="gauge-inner"></div>
        </div>

        <div class="weight-display">
            <div class="weight-num"><span id="weight-val">0.0</span><span class="unit">kg</span></div>
            <p id="fuel-status" style="font-weight: 800; margin-top: 10px; font-size: 14px; letter-spacing: 1px;">INITIALIZING...</p>
        </div>

        <div id="status-box" class="safe">
            <span id="leak-text">CONNECTING...</span>
        </div>

        <p id="time-stamp">LAST UPDATE: --:--:--</p>
    </div>

    <script>
    // 1. Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBerTPAkCYx2tj5A9fMhlcZnlLguMbimRg",
        authDomain: "gasmonitor-6e61b.firebaseapp.com",
        databaseURL: "https://gasmonitor-6e61b-default-rtdb.firebaseio.com",
        projectId: "gasmonitor-6e61b",
        storageBucket: "gasmonitor-6e61b.firebasestorage.app",
        messagingSenderId: "591726728932",
        appId: "1:591726728932:web:76fb463130844fc69e3ef1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. Real-time Database Listener
    db.ref('cylinder').on('value', (snapshot) => {
        const data = snapshot.val();
        
        if (data) {
            const weight = parseFloat(data.weight);
            const gauge = document.getElementById('gauge-progress');
            const statusText = document.getElementById('fuel-status');
            const timeText = document.getElementById('time-stamp');
            
            // Update Weight Number
            document.getElementById('weight-val').innerText = weight.toFixed(1);

            // Handle Timestamp: 
            // Priority 1: Use timestamp stored in DB by Arduino
            // Priority 2: Fallback to current browser time if DB timestamp is missing
            if (data.last_updated) {
                const dbDate = new Date(data.last_updated);
                timeText.innerText = "LAST DATA RECEIVED: " + dbDate.toLocaleTimeString();
            } else {
                timeText.innerText = "LAST UPDATED (LIVE): " + new Date().toLocaleTimeString();
            }

            // Gauge Fill Mapping (0kg = 0%, 15kg = 50% for semi-circle)
            let percent = (weight / 15) * 50; 
            if (percent > 50) percent = 50;
            if (percent < 0) percent = 0;
            gauge.style.setProperty('--percentage', percent + '%');

            // 6-LEVEL COLOR & LABEL LOGIC
            let color, msg;

            if (weight >= 15.0) {
                color = "#059669"; // Level 6: Exactly 15kg
                msg = "CYLINDER FULL";
            } else if (weight >= 12.0) {
                color = "#10b981"; // Level 5: 12kg to 14.9kg
                msg = "ALMOST FULL";
            } else if (weight >= 9.0) {
                color = "#84cc16"; // Level 4: 9kg to 11.9kg
                msg = "GOOD LEVEL";
            } else if (weight >= 6.0) {
                color = "#eab308"; // Level 3: 6kg to 8.9kg
                msg = "MEDIUM LEVEL";
            } else if (weight >= 3.0) {
                color = "#f97316"; // Level 2: 3kg to 5.9kg
                msg = "LOW LEVEL";
            } else {
                color = "#ef4444"; // Level 1: Under 3kg
                msg = "REFILL IMMEDIATELY";
            }

            // Apply visual updates to Gauge and Label
            gauge.style.setProperty('--g-color', color);
            statusText.innerText = msg;
            statusText.style.color = color;

            // Leakage Status Update
            const box = document.getElementById('status-box');
            const leakText = document.getElementById('leak-text');
            if (data.leakage === true) {
                leakText.innerText = "⚠ GAS LEAKAGE DETECTED";
                box.className = "danger";
            } else {
                leakText.innerText = "✔ SYSTEM SECURE";
                box.className = "safe";
            }
        }
    });
</script>
</body>
</html>
